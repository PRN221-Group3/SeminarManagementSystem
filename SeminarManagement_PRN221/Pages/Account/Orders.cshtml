@page
@model SeminarManagement_PRN221.Pages.Account.OrdersModel
@{
    Layout = "_Layout";
}
<h1>Orders</h1>

<table class="table table-striped table-bordered">
    <thead class="thead-dark">
        <tr>
            <th>Booking Id</th>
            <th>Event Name</th>
            <th>Event Code</th>
            <th>Event Fee</th>
            <th>Total Ticket</th>
            <th>Total Amount</th>
            <th>Event Start Date</th>
            <th>Event End Date</th>
            <th>Created Date</th>
            <th>Updated Date</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var order in Model.Bookings)
        {
            <tr>
                <td>@order.BookingId</td>
                <td>
                    <a href="/eventdetails?eventId=@order.EventId">@order.EventName</a>
                </td>
                <td>
                    <a href="/eventdetails?eventId=@order.EventId">@order.EventCode</a>
                </td>
                <td>@order.EventFee</td>
                <td>@order.TotalTicket</td>
                <td>$@order.TotalAmount</td>
                <td>@order.EventStartDate</td>
                <td>@order.EventEndDate</td>
                <td>@order.CreatedDate</td>
                <td>@order.UpdatedDate</td>
                <td>@order.TransactionStatus</td>
                @if (DateTime.Now >= order.EventStartDate && DateTime.Now <= @order.EventEndDate || DateTime.Now > order.EventEndDate)
                {
                    <td><button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#feedbackModal" data-booking-id="@order.BookingId">Give Feedback</button></td>
                }
            </tr>
        }
    </tbody>
</table>


<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">Give Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm">
                    <div class="form-group">
                        <label for="feedback">Your Feedback</label>
                        <textarea class="form-control" id="feedback" name="feedback" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="bookingId" name="bookingId" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitFeedback">Submit Feedback</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var feedbackModal = document.getElementById('feedbackModal');
        feedbackModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var bookingId = button.getAttribute('data-booking-id');
            var modalBodyInput = feedbackModal.querySelector('.modal-body #bookingId');
            modalBodyInput.value = bookingId;
        });

        document.getElementById('submitFeedback').addEventListener('click', function () {
            var feedback = document.getElementById('feedback').value;
            var bookingId = document.getElementById('bookingId').value;

            // Perform your AJAX call here to submit feedback
            fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    bookingId: bookingId,
                    feedback: feedback
                })
            })
                .then(response => response.json())
                .then(data => {
                    alert('Feedback submitted successfully!');
                    var feedbackModalElement = document.getElementById('feedbackModal');
                    var modal = bootstrap.Modal.getInstance(feedbackModalElement);
                    modal.hide();
                })
                .catch(error => {
                    alert('Error submitting feedback!');
                });
        });
    </script>
}